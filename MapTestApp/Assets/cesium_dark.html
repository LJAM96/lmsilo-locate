<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Cesium.js</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.111/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.111/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        html, body, #cesiumContainer {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        body { background: #000; }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>
    <script>
        Cesium.Ion.defaultAccessToken = undefined; // Disable Ion for offline

        const viewer = new Cesium.Viewer('cesiumContainer', {
            // Use Bing Maps for now (free for testing)
            // In production, use local tiles or NASA imagery
            imageryProvider: new Cesium.IonImageryProvider({ assetId: 3 }),

            baseLayerPicker: false,
            geocoder: false,
            homeButton: false,
            sceneModePicker: false,
            navigationHelpButton: false,
            animation: false,
            timeline: false,
            fullscreenButton: false,

            skyBox: false,
            skyAtmosphere: false
        });

        viewer.scene.backgroundColor = Cesium.Color.BLACK;
        viewer.scene.globe.enableLighting = true;
        viewer.scene.globe.nightFadeOutDistance = 10000000;

        const markers = [];

        function getColor(confidence) {
            if (confidence >= 0.85) return Cesium.Color.LIME;
            if (confidence >= 0.50) return Cesium.Color.YELLOW;
            return Cesium.Color.RED;
        }

        window.mapAPI = {
            addPin: function(lat, lon, label, confidence, rank, isExif) {
                const color = isExif ? Cesium.Color.CYAN : getColor(confidence);

                const entity = viewer.entities.add({
                    position: Cesium.Cartesian3.fromDegrees(lon, lat),
                    point: {
                        pixelSize: rank === 1 ? 14 : 10,
                        color: color,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 2,
                        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                    },
                    label: {
                        text: label,
                        font: '14px sans-serif',
                        fillColor: Cesium.Color.WHITE,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 2,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                        pixelOffset: new Cesium.Cartesian2(0, -15),
                        show: rank <= 3
                    },
                    description: `
                        <h3>${isExif ? 'üìç EXIF GPS' : `#${rank}`}</h3>
                        <p><strong>${label}</strong></p>
                        <p>Confidence: ${(confidence * 100).toFixed(1)}%</p>
                    `
                });

                markers.push(entity);
            },
            flyTo: function(lat, lon, zoom, duration) {
                viewer.camera.flyTo({
                    destination: Cesium.Cartesian3.fromDegrees(lon, lat, 5000000),
                    duration: (duration || 2000) / 1000,
                    orientation: {
                        heading: Cesium.Math.toRadians(0),
                        pitch: Cesium.Math.toRadians(-45),
                        roll: 0
                    }
                });
            }
        };

        console.log('Cesium initialized');
    </script>
</body>
</html>
